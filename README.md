# Лабораторная работа №2

Вариант: 

* LFU

## Задание

Для оптимизации работы с блочными устройствами в ОС существует кэш страниц с данными, которыми мы производим операции чтения и записи на диск. Такой кэш позволяет избежать высоких задержек при повторном доступе к данным, так как операция будет выполнена с данными в RAM, а не на диске (вспомним пирамиду памяти).

В данной лабораторной работе необходимо реализовать блочный кэш в пространстве пользователя в виде динамической библиотеки (dll или so). Политику вытеснения страниц и другие элементы задания необходимо получить у преподавателя.

При выполнении работы необходимо реализовать простой API для работы с файлами, предоставляющий пользователю следующие возможности:

1. Открытие файла по заданному пути файла, доступного для чтения. Процедура возвращает некоторый хэндл на файл. Пример:
`int lab2_open(const char *path)`.
2. Закрытие файла по хэндлу. Пример:
`int lab2_close(int fd)`.
3. Чтение данных из файла. Пример:
`ssize_t lab2_read(int fd, void buf[.count], size_t count)`.
4. Запись данных в файл. Пример:
`ssize_t lab2_write(int fd, const void buf[.count], size_t count)`.
5. Перестановка позиции указателя на данные файла. Достаточно поддержать только абсолютные координаты. Пример:
`off_t lab2_lseek(int fd, off_t offset, int whence)`.
6. Синхронизация данных из кэша с диском. Пример:
`int lab2_fsync(int fd)`.

Операции с диском разработанного блочного кеша должны производиться в обход page cache используемой ОС.

В рамках проверки работоспособности разработанного блочного кэша необходимо адаптировать указанную преподавателем программу-загрузчик из ЛР 1, добавив использование кэша. Запустите программу и убедитесь, что она корректно работает. Сравните производительность до и после.

### Ограничения
* Программа (комплекс программ) должна быть реализован на языке C или C++.
* Запрещено использовать высокоуровневые абстракции над системными вызовами. Необходимо использовать, в случае Unix, процедуры libc.

### Структура проекта

* `cache.h` - заголовочный файл с описанием API LFU кэша.
* `cache.c` - файл с реализацией кэша и его методов.


* `file-operations.h` - заголовочный файл с описанием API для работы с DDL-библиотекой.
* `file-operations.c` - файл с реализацией API для работы с DDL-библиотекой.

* `ema-sort-int.c` - файл с реализацией алгоритма сортировки.
* `ema-with-cache.c` - файл с реализацией программы-загрузчика с использованием кэша.

### Сравнение производительности нагрузчика с и без кэша

Работа программы-загрузчика без кэша:

```
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 52.70    0.134827          14      9216           write
 47.10    0.120498          12      9271           read
  0.14    0.000361           3       110           lseek
  0.05    0.000118          59         2           unlink
  0.01    0.000030           6         5           brk
  0.00    0.000012           2         5           close
  0.00    0.000000           0         2           fstat
  0.00    0.000000           0         8           mmap
  0.00    0.000000           0         3           mprotect
  0.00    0.000000           0         1           munmap
  0.00    0.000000           0         2           pread64
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         1           execve
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         1           set_tid_address
  0.00    0.000000           0         5           openat
  0.00    0.000000           0         1           set_robust_list
  0.00    0.000000           0         1           prlimit64
  0.00    0.000000           0         1           getrandom
  0.00    0.000000           0         1           rseq
------ ----------- ----------- --------- --------- ----------------
100.00    0.255846          13     18638         1 total
```

```
# started on Sun Jan 19 04:54:46 2025


 Performance counter stats for 'bin/ema-sort-int 1 output/ema-sort-int/file.bin':

            875.53 msec task-clock:u                     #    0.409 CPUs utilized             
                 0      context-switches:u               #    0.000 /sec                      
           454,489      cache-misses:u                   #   37.62% of all cache refs           (50.25%)
         1,208,238      cache-references:u               #    1.380 M/sec                       (54.41%)
       822,916,777      instructions:u                   #    1.25  insn per cycle              (63.75%)
       659,172,659      cycles:u                         #    0.753 GHz                         (60.84%)
       340,011,666      L1-dcache-loads:u                #  388.352 M/sec                       (62.54%)
         1,590,800      L1-dcache-load-misses:u          #    0.47% of all L1-dcache accesses   (62.36%)
           542,215      LLC-loads:u                      #  619.302 K/sec                       (60.44%)
           216,079      LLC-load-misses:u                #   39.85% of all LL-cache accesses    (49.16%)

       2.142339232 seconds time elapsed

       0.354455000 seconds user
       0.561897000 seconds sys


```

Работа программы-загрузчика с кэшем:

```
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 88.56    0.139275           3     37611           lseek
  7.64    0.012020          22       529           write
  3.62    0.005699           9       586           pread64
  0.08    0.000122           5        23           brk
  0.06    0.000100          50         2           unlink
  0.02    0.000032          10         3           fsync
  0.02    0.000025           4         6           close
  0.00    0.000000           0         2           read
  0.00    0.000000           0         3           fstat
  0.00    0.000000           0        12           mmap
  0.00    0.000000           0         4           mprotect
  0.00    0.000000           0         1           munmap
  0.00    0.000000           0         1         1 access
  0.00    0.000000           0         1           execve
  0.00    0.000000           0         1           getcwd
  0.00    0.000000           0         1           arch_prctl
  0.00    0.000000           0         1           set_tid_address
  0.00    0.000000           0         9         3 openat
  0.00    0.000000           0         1           set_robust_list
  0.00    0.000000           0         1           prlimit64
  0.00    0.000000           0         1           getrandom
  0.00    0.000000           0         1           rseq
------ ----------- ----------- --------- --------- ----------------
100.00    0.157273           4     38800         4 total
```

```
# started on Sun Jan 19 04:55:05 2025


 Performance counter stats for 'bin/ema-with-cache 1 output/ema-with-cache/file.bin':

            276.09 msec task-clock:u                     #    0.806 CPUs utilized             
                 0      context-switches:u               #    0.000 /sec                      
            76,102      cache-misses:u                   #    9.38% of all cache refs           (50.98%)
           811,426      cache-references:u               #    2.939 M/sec                       (48.58%)
       872,403,524      instructions:u                   #    1.16  insn per cycle              (63.28%)
       753,620,680      cycles:u                         #    2.730 GHz                         (62.86%)
       399,885,307      L1-dcache-loads:u                #    1.448 G/sec                       (62.10%)
         5,583,018      L1-dcache-load-misses:u          #    1.40% of all L1-dcache accesses   (62.88%)
           472,325      LLC-loads:u                      #    1.711 M/sec                       (63.87%)
            46,537      LLC-load-misses:u                #    9.85% of all LL-cache accesses    (48.74%)

       0.342688083 seconds time elapsed

       0.240602000 seconds user
       0.035241000 seconds sys


```